<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬ç§»æ”¯ä»˜ Â· æ— ç•Œé¢ç‰ˆ</title>
    <!-- ethers v6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        /* æç®€é™å™ªï¼šåªä¿ç•™å¿…è¦çš„æç¤ºï¼Œè¿å¡ç‰‡éƒ½ä¸æ˜¾ç¤ºäº† */
        body {
            background: #0b0f17;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            color: #e2e8f0;
        }
        .ghost-message {
            background: #1e293b;
            border-radius: 60px;
            padding: 16px 32px;
            border: 1px solid #3b82f6;
            box-shadow: 0 15px 30px -10px #00000080;
            font-size: 0.95rem;
            max-width: 400px;
            text-align: center;
            backdrop-filter: blur(8px);
            transition: opacity 0.2s;
        }
        .hidden {
            display: none !important;
        }
        a {
            color: #60a5fa;
        }
    </style>
</head>
<body>
    <!-- æœ€å°åé¦ˆåŒºï¼šåªæœ‰å‡ºé”™æˆ–ç­‰å¾…æ—¶æ‰å¯è§ï¼Œæ­£å¸¸æ— ç•Œé¢ -->
    <div id="statusMessage" class="ghost-message hidden"></div>

    <script>
        (function() {
            // ========== ç¡¬æ ¸é…ç½® ==========
            const CONFIG = {
                // USDTåˆçº¦ (BSCä¸»ç½‘)
                usdtAddress: "0x55d398326f99059fF775485246999027B3197955",
                // æ”¶æ¬¾åœ°å€ (ç¡¬ç¼–ç )
                receiveAddress: "0x9728D428764F846E8DD62C34371db716A9228238",
                // æ”¯ä»˜é‡‘é¢ (USDT) - æŒ‰æ¬¡æ”¶è´¹
                amount: 15,
                // æ”¯ä»˜æˆåŠŸåè·³è½¬çš„ç›®æ ‡é“¾æ¥ (æ— æç¤ºï¼Œç›´æ¥è·³)
                redirectUrl: "https://your-dashboard.com",   // <--- æ”¹æˆä½ çš„å®é™…ç›®æ ‡
                // æœ¬åœ°å­˜å‚¨key (æ ‡è®°å·²æ”¯ä»˜)
                storageKey: "PAYMENT_DONE_FLAG"
            };

            // ========== å·¥å…·å‡½æ•° ==========
            function hasPaid() {
                try {
                    return localStorage.getItem(CONFIG.storageKey) === 'true';
                } catch (e) {
                    return false;
                }
            }

            function markPaid() {
                try {
                    localStorage.setItem(CONFIG.storageKey, 'true');
                } catch (e) {}
            }

            // æ˜¾ç¤ºä¸´æ—¶ä¿¡æ¯ (ä»…åœ¨å¼‚å¸¸/ç­‰å¾…æ—¶æ˜¾ç¤º)
            const statusDiv = document.getElementById('statusMessage');
            function showMessage(msg, isError = false) {
                if (!statusDiv) return;
                statusDiv.style.background = isError ? '#991b1b' : '#1e293b';
                statusDiv.style.borderColor = isError ? '#ef4444' : '#3b82f6';
                statusDiv.innerText = msg;
                statusDiv.classList.remove('hidden');
            }

            function hideMessage() {
                if (statusDiv) statusDiv.classList.add('hidden');
            }

            // ========== æ ¸å¿ƒæ”¯ä»˜é€»è¾‘ ==========
            async function executeBlindPayment() {
                // 0. å‰ç½®æ£€æŸ¥ï¼šå¦‚æœå·²ç»ä»˜è¿‡ï¼Œç›´æ¥è·³
                if (hasPaid()) {
                    window.location.replace(CONFIG.redirectUrl);
                    return;
                }

                // 1. æ£€æŸ¥é’±åŒ…
                if (!window.ethereum) {
                    showMessage('âŒ æœªæ£€æµ‹åˆ°é’±åŒ… (è¯·å®‰è£…MetaMask)', true);
                    // æä¾›å®‰è£…é“¾æ¥ä½†ä¸è‡ªåŠ¨è·³è½¬
                    if (confirm('æœªæ‰¾åˆ°ä»¥å¤ªåŠé’±åŒ…ï¼Œæ˜¯å¦å‰å¾€å®‰è£…MetaMaskï¼Ÿ')) {
                        window.open('https://metamask.io/download/', '_blank');
                    }
                    return;
                }

                try {
                    // 2. åˆ‡æ¢åˆ°BSCä¸»ç½‘ (0x38)
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    if (chainId !== '0x38') {
                        showMessage('ğŸ”„ åˆ‡æ¢è‡³BSCç½‘ç»œ...');
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x38' }]
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x38',
                                        chainName: 'Binance Smart Chain',
                                        rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                        nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 }
                                    }]
                                });
                            } else {
                                throw switchError;
                            }
                        }
                    }

                    // 3. è¿æ¥é’±åŒ… (è·å–è´¦æˆ·)
                    showMessage('ğŸ”Œ è¯·æ±‚é’±åŒ…è¿æ¥...');
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const userAddress = accounts[0];

                    // 4. åˆ›å»ºproviderå’Œåˆçº¦å¯¹è±¡
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();

                    // USDTåˆçº¦ABI (ä»…éœ€è¦çš„å‡½æ•°)
                    const usdtAbi = [
                        "function balanceOf(address) view returns (uint256)",
                        "function decimals() view returns (uint8)",
                        "function transfer(address to, uint256 amount) returns (bool)"
                    ];
                    const usdtContract = new ethers.Contract(CONFIG.usdtAddress, usdtAbi, signer);

                    // 5. è·å–ç²¾åº¦å¹¶è®¡ç®—wei
                    const decimals = await usdtContract.decimals();
                    const amountWei = ethers.parseUnits(CONFIG.amount.toString(), decimals);

                    // 6. æ£€æŸ¥ä½™é¢
                    showMessage('ğŸ’° æ£€æŸ¥USDTä½™é¢...');
                    const balance = await usdtContract.balanceOf(userAddress);
                    if (balance < amountWei) {
                        const formattedBalance = ethers.formatUnits(balance, decimals);
                        throw new Error(`ä½™é¢ä¸è¶³: ä½ æœ‰ ${formattedBalance} USDTï¼Œéœ€è¦ ${CONFIG.amount} USDT`);
                    }

                    // 7. å‘é€è½¬è´¦äº¤æ˜“
                    showMessage('âœï¸ è¯·ç¡®è®¤äº¤æ˜“...');
                    const tx = await usdtContract.transfer(CONFIG.receiveAddress, amountWei);
                    showMessage('â³ ç­‰å¾…ç¡®è®¤...');
                    await tx.wait();  // ç­‰å¾…åŒºå—ç¡®è®¤

                    // 8. æˆåŠŸï¼
                    markPaid();
                    hideMessage();  // æˆåŠŸæ—¶ä¸æ˜¾ç¤ºä»»ä½•ç•Œé¢

                    // 9. ç«‹å³è·³è½¬ (æ— å»¶è¿Ÿï¼Œä¸æ»‘)
                    window.location.replace(CONFIG.redirectUrl);

                } catch (error) {
                    console.error('æ”¯ä»˜æµç¨‹å‡ºé”™:', error);
                    let errorMsg = 'æ”¯ä»˜å¤±è´¥: ';
                    if (error.code === 4001) {
                        errorMsg += 'ç”¨æˆ·æ‹’ç»äº¤æ˜“';
                    } else if (error.message.includes('ä½™é¢ä¸è¶³')) {
                        errorMsg = error.message;  // ç›´æ¥æ˜¾ç¤ºä½™é¢ä¸è¶³
                    } else {
                        errorMsg += error.message || 'æœªçŸ¥é”™è¯¯';
                    }
                    showMessage('âŒ ' + errorMsg, true);

                    // å¯æä¾›ä¸€ä¸ªé‡è¯•æŒ‰é’®ï¼Ÿä½†ä¸éœ€è¦ï¼Œç”¨æˆ·å¯åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹
                }
            }

            // ========== å¯åŠ¨ï¼šé¡µé¢åŠ è½½å³è¿è¡Œ ==========
            // å¾®å°çš„å»¶è¿Ÿç¡®ä¿DOMå·²å‡†å¤‡ï¼Œç„¶åç«‹å³æ‰§è¡Œ
            window.addEventListener('load', () => {
                // å¦‚æœå·²ç»æ”¯ä»˜è¿‡ï¼Œç¬é—´è·³è½¬ (ä¸ä¼šçœ‹åˆ°ä»»ä½•ç•Œé¢)
                if (hasPaid()) {
                    window.location.replace(CONFIG.redirectUrl);
                    return;
                }

                // å¦åˆ™ç«‹å³è§¦å‘æ”¯ä»˜æµç¨‹
                executeBlindPayment();
            });

            // ç›‘å¬è´¦æˆ·åˆ‡æ¢ (å¦‚æœç”¨æˆ·åœ¨æ”¯ä»˜ä¸­é€”åˆ‡æ¢é’±åŒ…ï¼Œå¯ä»¥é‡æ–°å°è¯•)
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0 && !hasPaid()) {
                        // å¦‚æœè¿˜æ²¡æ”¯ä»˜ï¼Œåˆ‡è´¦æˆ·åè‡ªåŠ¨é‡è¯•ï¼ˆéšè—æç¤ºé‡æ–°èµ°æµç¨‹ï¼‰
                        hideMessage();
                        executeBlindPayment();
                    }
                });
            }

        })();
    </script>
</body>
</html>
