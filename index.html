<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORACè´¨æŠ¼ç®¡ç† - ä¿®å¤ç‰ˆ</title>
    <!-- å¼•å…¥ Bootstrap ç”¨äºå¿«é€Ÿå¸ƒå±€ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Ethers.js V6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        /* ã€å…¨å±€æ ·å¼è®¾ç½®ã€‘ */
        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        .card { 
            background-color: #1e293b; 
            border: 1px solid #334155; 
        }
        .card-title { 
            color: #fff; 
        }
        .btn-primary { 
            background-color: #3b82f6; 
            border: none; 
        }
        .btn-primary:hover { 
            background-color: #2563eb; 
        }
        .btn-success { 
            background-color: #10b981; 
            border: none; 
        }
        .btn-warning { 
            background-color: #f59e0b; 
            border: none; 
            color: #fff; 
        }
        .btn-warning:hover { 
            background-color: #d97706; 
            color: #fff; 
        }
        .stat-value { 
            font-size: 1.25rem; 
            font-weight: bold; 
            color: #38bdf8; 
        }
        .stat-label { 
            font-size: 0.85rem; 
            color: #94a3b8; 
        }
        
        /* ã€è´¨æŠ¼æ“ä½œåŒºåŸŸç¾åŒ–æ ·å¼ã€‘ */
        .stake-operation-card {
            background: linear-gradient(145deg, #0d2739, #123047);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .stake-operation-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .stake-input-group {
            margin-bottom: 15px;
        }
        
        .stake-input-label {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 8px;
            display: block;
        }
        
        .stake-amount-input {
            width: 100%;
            padding: 12px;
            background-color: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .stake-amount-input:focus {
            outline: none;
            border-color: #0d9488;
            box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.2);
        }
        
        .duration-buttons {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        /* ã€è´¨æŠ¼å‘¨æœŸæŒ‰é’®æ ·å¼ - æ‰‹æœºç«¯ä¼˜åŒ–ã€‘ */
        .duration-btn {
            flex: 1;
            padding: 10px 4px;
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 2px solid #334155;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 60px; /* ã€è°ƒæ•´ç‚¹ï¼šæŒ‰é’®æœ€å°å®½åº¦ã€‘ */
        }
        
        .duration-btn:hover {
            border-color: #0d9488;
            color: #0d9488;
            transform: translateY(-2px);
        }
        
        .duration-btn.active {
            background: linear-gradient(90deg, #0d9488, #0a6c5f);
            border-color: #0d9488;
            color: white;
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
        }
        
        .stake-action-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(90deg, #0d9488, #0a6c5f);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stake-action-btn:hover {
            background: linear-gradient(90deg, #0a6c5f, #0d9488);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(13, 148, 136, 0.4);
        }
        
        .stake-action-btn:disabled {
            background: #475569;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* ã€è´¨æŠ¼è®°å½•å¡ç‰‡æ ·å¼ - å¡ç‰‡å¤§å°å’Œå­—ä½“è°ƒæ•´åŒºåŸŸã€‘ */
        /* ã€è°ƒæ•´ç‚¹1ï¼šå¡ç‰‡å®¹å™¨ç½‘æ ¼å¸ƒå±€ - å‹ç¼©å¡ç‰‡å¤§å°ï¼Œå¢åŠ æ¯è¡Œæ˜¾ç¤ºæ•°é‡ã€‘ */
        .stake-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* å‡å°æœ€å°å®½åº¦ */
            gap: 10px; /* å‡å°é—´è· */
            margin-top: 15px;
        }
        
        /* ã€å¡ç‰‡æ•´ä½“æ ·å¼ - å‹ç¼©å°ºå¯¸ã€‘ */
        .stake-card {
            background: linear-gradient(145deg, #0d9488, #134e4a);
            border-radius: 8px;
            padding: 10px; /* å‡å°å†…è¾¹è· */
            position: relative;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stake-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* ã€å¡ç‰‡å¤´éƒ¨ - å‹ç¼©ã€‘ */
        .stake-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px; /* å‡å°é—´è· */
            padding-bottom: 5px; /* å‡å°é—´è· */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* ã€è°ƒæ•´ç‚¹2ï¼šå¡ç‰‡IDå­—ä½“å¤§å° - è¿›ä¸€æ­¥ç¼©å°ã€‘ */
        .stake-card-id {
            font-size: 0.8rem; /* å‡å°å­—ä½“å¤§å° */
            font-weight: bold;
            color: #fff;
        }
        
        /* ã€è°ƒæ•´ç‚¹3ï¼šçŠ¶æ€æ ‡ç­¾å­—ä½“å¤§å° - è¿›ä¸€æ­¥ç¼©å°ã€‘ */
        .stake-card-status {
            font-size: 0.65rem; /* å‡å°å­—ä½“å¤§å° */
            padding: 2px 6px; /* å‡å°å†…è¾¹è· */
            border-radius: 12px; /* è°ƒæ•´ä¸ºæ›´å°çš„åœ†è§’ */
            font-weight: 600;
        }
        
        .status-locked {
            background-color: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .status-unlocked {
            background-color: rgba(34, 197, 94, 0.2);
            color: #34d399;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .status-completed {
            background-color: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }
        
        /* ã€å¡ç‰‡ä¿¡æ¯åŒºåŸŸ - å‹ç¼©ã€‘ */
        .stake-card-info {
            margin-bottom: 8px; /* å‡å°é—´è· */
        }
        
        /* ã€è°ƒæ•´ç‚¹4ï¼šè´¨æŠ¼é‡‘é¢å­—ä½“å¤§å° - è¿›ä¸€æ­¥ç¼©å°ã€‘ */
        .stake-amount {
            font-size: 0.9rem; /* å‡å°å­—ä½“å¤§å° */
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
        }
        
        .stake-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px; /* å‡å°é—´è· */
        }
        
        /* ã€è°ƒæ•´ç‚¹5ï¼šè´¨æŠ¼å‘¨æœŸå­—ä½“å¤§å° - è¿›ä¸€æ­¥ç¼©å°ã€‘ */
        .stake-duration {
            color: #94a3b8;
            font-size: 0.75rem; /* å‡å°å­—ä½“å¤§å° */
            display: flex;
            align-items: center;
            gap: 3px; /* å‡å°é—´è· */
        }
        
        /* ã€è°ƒæ•´ç‚¹6ï¼šè´¨æŠ¼æ—¶é—´å­—ä½“å¤§å° - è¿›ä¸€æ­¥ç¼©å°ã€‘ */
        .stake-time {
            color: #94a3b8;
            font-size: 0.65rem; /* å‡å°å­—ä½“å¤§å° */
        }
        
        /* ã€è¿›åº¦æ¡åŒºåŸŸ - å‹ç¼©ã€‘ */
        .stake-progress {
            margin: 8px 0; /* å‡å°é—´è· */
        }
        
        .stake-progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px; /* å‡å°é—´è· */
            font-size: 0.7rem; /* è¿›ä¸€æ­¥ç¼©å° */
        }
        
        .stake-remaining-time {
            color: #e2e8f0;
        }
        
        .stake-progress-percent {
            color: #38bdf8;
            font-weight: 600;
        }
        
        .stake-progress-bar {
            height: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .stake-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        /* ã€å¡ç‰‡æ“ä½œæŒ‰é’®åŒºåŸŸ - å‹ç¼©ã€‘ */
        .stake-card-actions {
            margin-top: 8px; /* å‡å°é—´è· */
            padding-top: 8px; /* å‡å°é—´è· */
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        /* ã€ç©ºçŠ¶æ€æ ·å¼ã€‘ */
        .stake-empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px 15px; /* å‡å°å†…è¾¹è· */
            color: #94a3b8;
            background-color: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            border: 2px dashed #475569;
        }
        
        .stake-empty-icon {
            font-size: 1.5rem; /* å‡å°å›¾æ ‡å¤§å° */
            margin-bottom: 8px; /* å‡å°é—´è· */
            color: #475569;
        }
        
        .stake-empty-text {
            font-size: 0.85rem; /* å‡å°å­—ä½“å¤§å° */
            margin-bottom: 4px; /* å‡å°é—´è· */
        }
        
        .stake-empty-subtext {
            font-size: 0.75rem; /* å‡å°å­—ä½“å¤§å° */
            color: #64748b;
        }
        
        /* ã€çŠ¶æ€ç­›é€‰æŒ‰é’®æ ·å¼ã€‘ */
        .status-filter {
            display: flex;
            gap: 6px; /* å‡å°é—´è· */
            margin-bottom: 12px; /* å‡å°é—´è· */
            flex-wrap: wrap;
        }
        
        .status-filter-btn {
            font-size: 0.75rem; /* å‡å°å­—ä½“å¤§å° */
            padding: 3px 10px; /* å‡å°å†…è¾¹è· */
            border-radius: 20px;
            border: 1px solid #475569;
            background-color: #1e293b;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .status-filter-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .status-filter-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        /* ================= ã€å“åº”å¼è°ƒæ•´ - æ‰‹æœºç«¯ä¼˜åŒ–ã€‘ ================= */
        @media (max-width: 768px) {
            /* ã€è°ƒæ•´ç‚¹7ï¼šæ‰‹æœºç«¯å¡ç‰‡å¸ƒå±€ã€‘æ”¹ä¸ºå•åˆ—æ˜¾ç¤º */
            .stake-card-container {
                grid-template-columns: 1fr;
            }
            
            /* ã€è°ƒæ•´ç‚¹8ï¼šæ‰‹æœºç«¯æŒ‰é’®è¿›ä¸€æ­¥ç¼©å°ã€‘ */
            .duration-buttons {
                flex-wrap: nowrap;
                gap: 4px;
            }
            
            .duration-btn {
                padding: 8px 3px;
                font-size: 0.8rem;
                min-width: 50px;
            }
            
            /* ã€è°ƒæ•´ç‚¹9ï¼šæ‰‹æœºç«¯å¡ç‰‡å†…å­—ä½“å¤§å°ã€‘ */
            .stake-card-id {
                font-size: 0.75rem;
            }
            
            .stake-amount {
                font-size: 0.85rem;
            }
            
            /* åœ¨æ‰‹æœºä¸Šè°ƒæ•´ç»Ÿè®¡å¡ç‰‡å¸ƒå±€ */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1200px) {
            /* ã€è°ƒæ•´ç‚¹10ï¼šå¹³æ¿ç«¯æ˜¾ç¤ºåˆ—æ•° - å¢åŠ åˆ—æ•°ã€‘ */
            .stake-card-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 1201px) {
            /* ã€è°ƒæ•´ç‚¹11ï¼šæ¡Œé¢ç«¯æ˜¾ç¤ºåˆ—æ•° - å¢åŠ åˆ—æ•°ã€‘ */
            .stake-card-container {
                grid-template-columns: repeat(4, 1fr); /* æ¡Œé¢ç«¯æ¯è¡Œæ˜¾ç¤º4ä¸ªå¡ç‰‡ */
            }
        }
        
        /* ã€æ€»ç»Ÿè®¡æ•°æ®å¡ç‰‡æ ·å¼ã€‘ */
        .total-stats-card { 
            border-left: 4px solid #3b82f6; 
        }
        
        .team-stats-card { 
            border-left: 4px solid #10b981; 
        }
        
        /* ã€æ¯æ—¥æ•°æ®å¡ç‰‡æ ·å¼ã€‘ */
        .daily-stats-card { 
            border-left: 4px solid #f59e0b; 
        }
        
        /* ã€æ³¨å†Œæ¨èäººåŒºåŸŸã€‘ */
        .register-card {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }
        
        .register-input {
            width: 100%;
            padding: 10px;
            background-color: #334155;
            border: 1px solid #475569;
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
        }
        
        .register-btn {
            padding: 10px 20px;
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* ã€ç»Ÿè®¡æ•°æ®å®¹å™¨ç½‘æ ¼å¸ƒå±€ã€‘ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: #1e293b;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #334155;
        }
        
        /* ã€æ¯æ—¥ç»Ÿè®¡ç½‘æ ¼ã€‘ */
        .daily-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        /* ã€åŠ è½½ä¸­æ ·å¼ã€‘ */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #0d9488;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div class="container py-4">
    <!-- ã€é’±åŒ…è¿æ¥åŒºåŸŸã€‘ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">ORACè´¨æŠ¼ç®¡ç† - ä¿®å¤ç‰ˆ</h3>
        <button id="connectBtn" class="btn btn-primary" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
    </div>

    <!-- ã€æ³¨å†Œæ¨èäººåŒºåŸŸã€‘ -->
    <div id="registerCard" class="register-card" style="display: none;">
        <h5 class="card-title mb-3">é¦–æ¬¡ä½¿ç”¨è¯·æ³¨å†Œæ¨èäºº</h5>
        <div class="row g-3">
            <div class="col-md-8">
                <label class="stake-input-label">æ¨èäººåœ°å€ï¼ˆå·²æ³¨å†Œç”¨æˆ·ï¼‰</label>
                <input type="text" class="register-input" id="referralAddress" placeholder="è¾“å…¥æ¨èäººåœ°å€" value="">
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button class="register-btn" onclick="registerUser()">æ³¨å†Œè´¦å·</button>
            </div>
        </div>
        <div class="mt-2 small text-white">
            * é¦–æ¬¡å‚ä¸è´¨æŠ¼éœ€è¦æ³¨å†Œï¼Œè¯·è¾“å…¥æ¨èäººåœ°å€
        </div>
    </div>

    <!-- ã€æ•°æ®ç»Ÿè®¡é¢æ¿ - ç½‘æ ¼å¸ƒå±€ã€‘ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">æˆ‘çš„ USDT ä½™é¢</div>
            <div class="stat-value" id="myBalance">0.0000</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ä¸ªäººæ€»è´¨æŠ¼</div>
            <div class="stat-value" id="stakedBalance">0.0000</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">å¯æå–æ”¶ç›Š</div>
            <div class="stat-value" id="pendingRewards">0.0000</div>
        </div>
        <div class="stat-card total-stats-card">
            <div class="stat-label">åˆçº¦æ€»è´¨æŠ¼</div>
            <div class="stat-value" id="totalStaked">0.0000</div>
        </div>
    </div>
    
    <!-- ã€å›¢é˜Ÿç»Ÿè®¡æ•°æ®é¢æ¿ - æ–°å¢ã€‘ -->
    <div class="stats-grid">
        <div class="stat-card team-stats-card">
            <div class="stat-label">å›¢é˜Ÿæ€»ä¸šç»©</div>
            <div class="stat-value" id="teamTotalPerformance">0.0000</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">å›¢é˜Ÿæ€»äººæ•°</div>
            <div class="stat-value" id="teamTotalMembers">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ç›´æ¨äººæ•°</div>
            <div class="stat-value" id="directReferrals">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">å·²ç»“ç®—å›¢é˜Ÿå¥–åŠ±</div>
            <div class="stat-value" id="teamSettledRewards">0.0000</div>
        </div>
    </div>
    
    <!-- ã€æ¯æ—¥æ•°æ®ç»Ÿè®¡ - æ–°å¢ã€‘ -->
    <div class="daily-stats-grid">
        <div class="stat-card daily-stats-card">
            <div class="stat-label">ä»Šæ—¥è´¨æŠ¼é‡</div>
            <div class="stat-value" id="todayStakeAmount">0.0000</div>
        </div>
        <div class="stat-card daily-stats-card">
            <div class="stat-label">ä»Šæ—¥èµå›é‡</div>
            <div class="stat-value" id="todayRedeemAmount">0.0000</div>
        </div>
    </div>

    <!-- ã€è´¨æŠ¼æ“ä½œåŒºåŸŸ - ç®€åŒ–ç‰ˆæ ·å¼ã€‘ -->
    <div class="stake-operation-card">
        <div class="stake-operation-title">å‚ä¸è´¨æŠ¼</div>
        
        <div class="stake-input-group">
            <label class="stake-input-label">è´¨æŠ¼é‡‘é¢ (USDT)</label>
            <input type="number" class="stake-amount-input" id="stakeAmount" value="1000" placeholder="è¾“å…¥é‡‘é¢">
        </div>
        
        <div class="duration-selection">
            <label class="stake-input-label">é€‰æ‹©è´¨æŠ¼å‘¨æœŸ</label>
            <div class="duration-buttons">
                <button class="duration-btn active" onclick="selectDuration(1, this)">1å¤©</button>
                <button class="duration-btn" onclick="selectDuration(15, this)">15å¤©</button>
                <button class="duration-btn" onclick="selectDuration(30, this)">30å¤©</button>
            </div>
        </div>
        
        <button class="stake-action-btn" onclick="handleStake()">ç«‹å³è´¨æŠ¼</button>
    </div>

    <!-- ã€æˆ‘çš„è´¨æŠ¼è®°å½•åŒºåŸŸã€‘ -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">æˆ‘çš„è´¨æŠ¼è®°å½•</h5>
                <div>
                    <button class="btn btn-sm btn-outline-light" onclick="refreshData()">åˆ·æ–°æ•°æ®</button>
                </div>
            </div>
            
            <!-- ã€çŠ¶æ€ç­›é€‰ã€‘ -->
            <div class="status-filter">
                <button class="status-filter-btn active" onclick="filterMyStakes('active')">è´¨æŠ¼ä¸­</button>
                <button class="status-filter-btn" onclick="filterMyStakes('completed')">å·²èµå›</button>
                <button class="status-filter-btn" onclick="filterMyStakes('all')">å…¨éƒ¨è®°å½•</button>
            </div>
            
            <!-- ã€å¡ç‰‡å¼å¸ƒå±€å®¹å™¨ - å‹ç¼©ç‰ˆã€‘ -->
            <div id="stakeCardsContainer" class="stake-card-container">
                <div class="stake-empty-state">
                    <div class="stake-empty-icon">ğŸ“Š</div>
                    <div class="stake-empty-text">æš‚æ— è´¨æŠ¼è®°å½•</div>
                    <div class="stake-empty-subtext">è¿æ¥é’±åŒ…åï¼Œæ‚¨çš„è´¨æŠ¼è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¼•å…¥ Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ================= ã€é…ç½®åŒºåŸŸ - éœ€è¦æ›¿æ¢çš„åœ°æ–¹ã€‘ =================
    // ã€æ³¨æ„ï¼šå¦‚æœè¦æ›´æ¢åˆçº¦åœ°å€ï¼Œéœ€è¦ä¿®æ”¹ä»¥ä¸‹åœ°å€ã€‘
    const CONFIG = {
        STAKING: "0x166bf0160e88aa4c12298B832582d1d062eb1d9B",  // ã€ORACè´¨æŠ¼åˆçº¦åœ°å€ã€‘
        USDT: "0x55d398326f99059fF775485246999027B3197955",    // ã€USDTä»£å¸åœ°å€ - BSCä¸»ç½‘ã€‘
        ROUTER: "0x10ED43C718714eb63d5aA57B78B54704E256024E"   // ã€PancakeSwap Routeråœ°å€ã€‘
    };
    
    // ã€è´¨æŠ¼å‘¨æœŸé…ç½® (ç§’)ã€‘
    const STAKE_DURATIONS = {
        1: 86400,        // 1å¤©
        15: 1296000,     // 15å¤© (15 * 86400)
        30: 2592000      // 30å¤© (30 * 86400)
    };
    
    const STAKE_DURATION_LABELS = {
        1: "1å¤©",
        15: "15å¤©", 
        30: "30å¤©"
    };
    // ============================================================

    // ================= ã€ABIé…ç½® - ä½¿ç”¨æ‚¨æä¾›çš„å®Œæ•´ABIã€‘ =================
    const ABI_ERC20 = [
        "function balanceOf(address owner) view returns (uint256)",
        "function decimals() view returns (uint8)",
        "function approve(address spender, uint256 amount) returns (bool)",
        "function allowance(address owner, address spender) view returns (uint256)"
    ];

    const ABI_STAKING = [{"inputs":[{"internalType":"address","name":"first","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"AlreadyRedeemed","type":"error"},{"inputs":[],"name":"InvalidAmount","type":"error"},{"inputs":[],"name":"InvalidLevel","type":"error"},{"inputs":[],"name":"InvalidLockDays","type":"error"},{"inputs":[],"name":"StakeLimitExceeded","type":"error"},{"inputs":[],"name":"UplineNotExists","type":"error"},{"inputs":[],"name":"UserNotRegistered","type":"error"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"uint256","name":"idx","type":"uint256"}],"name":"Redeem","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"uint256","name":"idx","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RedeemBreak","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"address","name":"up","type":"address"}],"name":"Register","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"addr","type":"address"},{"indexed":false,"internalType":"uint256","name":"lockDays","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"idx","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"Stake","type":"event"},{"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"breakTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"usdtAmount","type":"uint256"},{"internalType":"uint256","name":"minTokenAmount","type":"uint256"}],"name":"buyORAC","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"p","type":"uint256"},{"internalType":"uint256","name":"s","type":"uint256"}],"name":"calLevelAllowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"stakeDay","type":"uint256"},{"internalType":"uint256","name":"stakeTime","type":"uint256"}],"name":"calReward","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"a","type":"uint256"},{"internalType":"uint256","name":"d","type":"uint256"}],"name":"calTeamAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"contractInfo","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"day15cycle","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"day30cycle","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"expireAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getAllReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint256","name":"pageNum","type":"uint256"},{"internalType":"uint256","name":"pageSize","type":"uint256"}],"name":"getDirectsByPage","outputs":[{"internalType":"address[]","name":"directAddrs","type":"address[]"},{"internalType":"uint256[]","name":"personalAmounts","type":"uint256[]"},{"internalType":"uint256[]","name":"downlineAmounts","type":"uint256[]"},{"internalType":"uint256[]","name":"stakeAmounts","type":"uint256[]"},{"internalType":"uint256","name":"total","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"id2Address","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"components":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint144","name":"stakeAmount","type":"uint144"},{"internalType":"uint32","name":"stakeTime","type":"uint32"}],"internalType":"struct Staking.StakeOrder[]","name":"orders","type":"tuple[]"}],"name":"importStakes","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"importTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"stakeDay","type":"uint256"},{"internalType":"uint256","name":"cycle","type":"uint256"}],"name":"isNeedRestake","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"}],"name":"isUserExists","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxlpusdt","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rateInfo","outputs":[{"internalType":"uint256[]","name":"rs","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"idx","type":"uint256"},{"internalType":"uint256","name":"usdtAmount","type":"uint256"},{"internalType":"uint256","name":"minTokenAmount","type":"uint256"},{"internalType":"uint256","name":"stakeDay","type":"uint256"}],"name":"redeem","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"up","type":"address"}],"name":"register","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"downs","type":"address[]"},{"internalType":"address[]","name":"ups","type":"address[]"}],"name":"registerBatch","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"setA","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"c","type":"uint256"}],"name":"setC","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"d1","type":"uint256"},{"internalType":"uint256","name":"d3","type":"uint256"}],"name":"setD","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"e","type":"address"}],"name":"setE","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint32","name":"f","type":"uint32"}],"name":"setF","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"i","type":"uint256"}],"name":"setI","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint256","name":"lvl","type":"uint256"}],"name":"setLevel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"idx","type":"uint256"},{"internalType":"uint256","name":"r","type":"uint256"}],"name":"setLevelRewardRates","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint256","name":"idx","type":"uint256"}],"name":"setUserExpire","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"skim","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"usdtAmount","type":"uint256"},{"internalType":"uint256","name":"minTokenAmount","type":"uint256"},{"internalType":"uint256","name":"stakeDay","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"updateAllowance","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"updateBreak","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"updateCycle","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"updateORAC","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"}],"name":"userInfo","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"}],"name":"userOtherInfo","outputs":[{"internalType":"uint96","name":"","type":"uint96"},{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"}],"name":"userStakeInfo","outputs":[{"components":[{"internalType":"uint144","name":"stakeAmount","type":"uint144"},{"internalType":"uint32","name":"stakeTime","type":"uint32"},{"internalType":"uint32","name":"breakRewardTime","type":"uint32"},{"internalType":"uint32","name":"cycle","type":"uint32"},{"internalType":"uint8","name":"stakeDay","type":"uint8"},{"internalType":"uint8","name":"isRedeem","type":"uint8"}],"internalType":"struct Staking.StakeInfo[]","name":"s","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint256","name":"pageNum","type":"uint256"},{"internalType":"uint256","name":"pageSize","type":"uint256"}],"name":"userStakeInfoByPage","outputs":[{"components":[{"internalType":"uint144","name":"stakeAmount","type":"uint144"},{"internalType":"uint32","name":"stakeTime","type":"uint32"},{"internalType":"uint32","name":"breakRewardTime","type":"uint32"},{"internalType":"uint32","name":"cycle","type":"uint32"},{"internalType":"uint8","name":"stakeDay","type":"uint8"},{"internalType":"uint8","name":"isRedeem","type":"uint8"}],"internalType":"struct Staking.StakeInfo[]","name":"result","type":"tuple[]"},{"internalType":"uint256","name":"total","type":"uint256"}],"stateMutability":"view","type":"function"}];
    // ============================================================

    // å…¨å±€å˜é‡
    let provider, signer, userAddress;
    let stakingContract, usdtContract;
    let countdownTimers = {};
    let selectedDuration = 1; // é»˜è®¤é€‰æ‹©1å¤©
    
    // ç­›é€‰çŠ¶æ€
    let myStakeFilter = 'active'; // æˆ‘çš„è´¨æŠ¼è®°å½•ç­›é€‰ï¼šactive=è´¨æŠ¼ä¸­, completed=å·²èµå›, all=å…¨éƒ¨
    
    // æ¯æ—¥ç»Ÿè®¡å˜é‡
    let todayStakeAmount = 0;
    let todayRedeemAmount = 0;
    let todayTimestamp = 0;

    // å·¥å…·å‡½æ•°
    function formatAmount(wei) {
        const val = ethers.formatUnits(wei, 18);
        return parseFloat(val).toFixed(0);
    }
    
    function formatAmountTwoDecimals(wei) {
        const val = ethers.formatUnits(wei, 18);
        return parseFloat(val).toFixed(2);
    }

    function formatTimeRemaining(seconds) {
        if (seconds <= 0) return "0ç§’";
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        let result = "";
        if (days > 0) result += `${days}å¤©`;
        if (hours > 0) result += `${hours}å°æ—¶`;
        if (minutes > 0 && days === 0) result += `${minutes}åˆ†`;
        return result || "0ç§’";
    }
    
    function formatTimeShort(seconds) {
        if (seconds <= 0) return "0s";
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        let result = "";
        if (hours > 0) result += `${hours}h`;
        if (minutes > 0) result += `${minutes}m`;
        if (secs > 0 && hours === 0) result += `${secs}s`;
        return result || "0s";
    }

    function formatStakeTime(timestamp) {
        const date = new Date(timestamp * 1000);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hour = date.getHours().toString().padStart(2, '0');
        const minute = date.getMinutes().toString().padStart(2, '0');
        return `${month}/${day} ${hour}:${minute}`;
    }

    function calculateProgress(stakeTime, totalDuration, cycle) {
        const now = Math.floor(Date.now() / 1000);
        const elapsedTime = now - stakeTime;
        const totalLockSeconds = totalDuration * cycle;
        if (elapsedTime >= totalLockSeconds) return 100;
        return Math.min(100, Math.floor((elapsedTime / totalLockSeconds) * 100));
    }
    
    // è·å–ä»Šå¤©çš„å¼€å§‹æ—¶é—´æˆ³ï¼ˆUTCæ—¶é—´ï¼‰
    function getTodayStartTimestamp() {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        return Math.floor(today.getTime() / 1000);
    }

    // é€‰æ‹©è´¨æŠ¼å‘¨æœŸ
    function selectDuration(days, element) {
        selectedDuration = days;
        document.querySelectorAll('.duration-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        element.classList.add('active');
    }

    // ç­›é€‰æˆ‘çš„è´¨æŠ¼è®°å½•
    function filterMyStakes(filterType) {
        myStakeFilter = filterType;
        renderStakeCards();
    }

    // 1. è¿æ¥é’±åŒ…
    async function connectWallet() {
        if (!window.ethereum) {
            alert("è¯·å®‰è£… MetaMask!");
            return;
        }
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            
            document.getElementById('connectBtn').innerText = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
            document.getElementById('connectBtn').classList.replace('btn-primary', 'btn-success');

            stakingContract = new ethers.Contract(CONFIG.STAKING, ABI_STAKING, signer);
            usdtContract = new ethers.Contract(CONFIG.USDT, ABI_ERC20, signer);

            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æ³¨å†Œ
            await checkUserRegistration();
            
            // è·å–ä»Šæ—¥æ—¶é—´æˆ³
            todayTimestamp = getTodayStartTimestamp();
            
            await refreshData();
        } catch (error) {
            console.error("è¿æ¥å¤±è´¥:", error);
            alert("è¿æ¥é’±åŒ…å¤±è´¥");
        }
    }

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æ³¨å†Œ
    async function checkUserRegistration() {
        try {
            const isRegistered = await stakingContract.isUserExists(userAddress);
            if (!isRegistered) {
                // æ˜¾ç¤ºæ³¨å†Œå¡
                document.getElementById('registerCard').style.display = 'block';
            } else {
                // éšè—æ³¨å†Œå¡
                document.getElementById('registerCard').style.display = 'none';
            }
        } catch (error) {
            console.error("æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒçŠ¶æ€å¤±è´¥:", error);
        }
    }

    // æ³¨å†Œç”¨æˆ·
    async function registerUser() {
        if (!userAddress) {
            alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            return;
        }
        
        const referralAddress = document.getElementById('referralAddress').value;
        if (!referralAddress || !ethers.isAddress(referralAddress)) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ¨èäººåœ°å€");
            return;
        }
        
        try {
            const registerBtn = document.getElementById('registerCard').querySelector('.register-btn');
            const originalText = registerBtn.textContent;
            registerBtn.disabled = true;
            registerBtn.textContent = "æ³¨å†Œä¸­...";
            
            const tx = await stakingContract.register(referralAddress);
            await tx.wait();
            
            alert("æ³¨å†ŒæˆåŠŸï¼");
            document.getElementById('registerCard').style.display = 'none';
            await refreshData();
            
        } catch (error) {
            console.error("æ³¨å†Œå¤±è´¥:", error);
            if (error.reason) {
                alert(`æ³¨å†Œå¤±è´¥: ${error.reason}`);
            } else {
                alert("æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°");
            }
        } finally {
            const registerBtn = document.getElementById('registerCard').querySelector('.register-btn');
            registerBtn.disabled = false;
            registerBtn.textContent = "æ³¨å†Œè´¦å·";
        }
    }

    // 2. åˆ·æ–°æ‰€æœ‰æ•°æ®
    async function refreshData() {
        if (!userAddress) return;
        const btn = document.querySelector('button[onclick="refreshData()"]');
        const originalText = btn.innerText;
        btn.innerText = "åŠ è½½ä¸­...";
        
        try {
            // è·å–æˆ‘çš„ USDT ä½™é¢
            const myBal = await usdtContract.balanceOf(userAddress);
            document.getElementById('myBalance').innerText = formatAmount(myBal);

            // ã€ä¿®å¤ç‚¹1ï¼šè·å–ä¸ªäººæ€»è´¨æŠ¼ - ä»è´¨æŠ¼è®°å½•ä¸­è®¡ç®—ã€‘
            await calculatePersonalStakedBalance();
            
            // è·å–ç”¨æˆ·ä¿¡æ¯
            const userInfoData = await stakingContract.userInfo(userAddress);
            const pendingRewards = userInfoData[2]; // å¯æå–æ”¶ç›Š
            
            document.getElementById('pendingRewards').innerText = formatAmount(pendingRewards);

            // ã€ä¿®å¤ç‚¹2ï¼šè·å–åˆçº¦æ€»è´¨æŠ¼ - ä»è´¨æŠ¼è®°å½•ä¸­è®¡ç®—ã€‘
            await calculateContractTotalStaked();
            
            // è·å–å›¢é˜Ÿä¿¡æ¯
            document.getElementById('teamTotalPerformance').innerText = formatAmount(userInfoData[6]); // å›¢é˜Ÿæ€»ä¸šç»©
            document.getElementById('directReferrals').innerText = userInfoData[3]; // ç›´æ¨äººæ•°
            document.getElementById('teamTotalMembers').innerText = userInfoData[4]; // å›¢é˜Ÿæ€»äººæ•°
            document.getElementById('teamSettledRewards').innerText = formatAmount(userInfoData[7]); // å·²ç»“ç®—å›¢é˜Ÿå¥–åŠ±

            // ã€ä¿®å¤ç‚¹3ï¼šè®¡ç®—æ¯æ—¥è´¨æŠ¼é‡å’Œèµå›é‡ã€‘
            await calculateDailyStats();
            
            // è·å–è´¨æŠ¼åˆ—è¡¨
            await renderStakeCards();
            btn.innerText = "åˆ·æ–°";
        } catch (error) {
            console.error("æ•°æ®åŠ è½½é”™è¯¯:", error);
        } finally {
            btn.innerText = originalText;
        }
    }
    
    // ã€æ–°å¢ï¼šè®¡ç®—ä¸ªäººæ€»è´¨æŠ¼ - ä»è´¨æŠ¼è®°å½•ä¸­è®¡ç®—ã€‘
    async function calculatePersonalStakedBalance() {
        if (!userAddress) return;
        
        try {
            // è·å–è´¨æŠ¼è®°å½•
            const stakeInfo = await stakingContract.userStakeInfo(userAddress);
            let totalPersonalStaked = ethers.parseUnits("0", 18);
            
            // éå†æ‰€æœ‰è´¨æŠ¼è®°å½•ï¼Œåªè®¡ç®—æœªèµå›çš„
            for (let i = 0; i < stakeInfo.length; i++) {
                const record = stakeInfo[i];
                if (record.isRedeem === 0) { // åªè®¡ç®—æœªèµå›çš„
                    totalPersonalStaked += record.stakeAmount;
                }
            }
            
            document.getElementById('stakedBalance').innerText = formatAmount(totalPersonalStaked);
            
        } catch (error) {
            console.error("è®¡ç®—ä¸ªäººæ€»è´¨æŠ¼å¤±è´¥:", error);
            document.getElementById('stakedBalance').innerText = "0.00";
        }
    }
    
    // ã€æ–°å¢ï¼šè®¡ç®—åˆçº¦æ€»è´¨æŠ¼ - ä»è´¨æŠ¼è®°å½•ä¸­è®¡ç®—ï¼ˆæ³¨æ„ï¼šè¿™åªèƒ½è®¡ç®—å½“å‰ç”¨æˆ·çš„è´¨æŠ¼ï¼ŒçœŸæ­£çš„åˆçº¦æ€»è´¨æŠ¼éœ€è¦åˆçº¦å‡½æ•°ï¼‰ã€‘
    async function calculateContractTotalStaked() {
        if (!userAddress) return;
        
        try {
            // è¿™é‡Œä»åˆçº¦çš„contractInfoå‡½æ•°è·å–æ€»è´¨æŠ¼
            // æ ¹æ®åˆçº¦ABIï¼ŒcontractInfoè¿”å›5ä¸ªå€¼ï¼Œç¬¬1ä¸ªåº”è¯¥æ˜¯åˆçº¦æ€»è´¨æŠ¼
            const contractInfoData = await stakingContract.contractInfo();
            const totalStaked = contractInfoData[0];
            document.getElementById('totalStaked').innerText = formatAmount(totalStaked);
            
        } catch (error) {
            console.error("è·å–åˆçº¦æ€»è´¨æŠ¼å¤±è´¥:", error);
            // å¦‚æœæ— æ³•è·å–ï¼Œå°è¯•ä»è´¨æŠ¼è®°å½•ä¸­è®¡ç®—å½“å‰ç”¨æˆ·çš„æ€»è´¨æŠ¼
            try {
                const stakeInfo = await stakingContract.userStakeInfo(userAddress);
                let totalStaked = ethers.parseUnits("0", 18);
                
                for (let i = 0; i < stakeInfo.length; i++) {
                    const record = stakeInfo[i];
                    if (record.isRedeem === 0) { // åªè®¡ç®—æœªèµå›çš„
                        totalStaked += record.stakeAmount;
                    }
                }
                
                document.getElementById('totalStaked').innerText = formatAmount(totalStaked) + " (ä»…å½“å‰ç”¨æˆ·)";
            } catch (err) {
                console.error("è®¡ç®—æ€»è´¨æŠ¼å¤±è´¥:", err);
                document.getElementById('totalStaked').innerText = "0.00";
            }
        }
    }
    
    // ã€ä¿®å¤ç‚¹4ï¼šä¿®å¤æ¯æ—¥è´¨æŠ¼é‡å’Œèµå›é‡çš„è®¡ç®—ã€‘
    async function calculateDailyStats() {
        if (!userAddress) return;
        
        try {
            // é‡ç½®æ¯æ—¥ç»Ÿè®¡
            todayStakeAmount = 0;
            todayRedeemAmount = 0;
            
            // è·å–è´¨æŠ¼è®°å½•
            const stakeInfo = await stakingContract.userStakeInfo(userAddress);
            const now = Math.floor(Date.now() / 1000);
            
            // è®¡ç®—ä»Šå¤©å¼€å§‹çš„æ—¶é—´æˆ³
            const todayStart = getTodayStartTimestamp();
            
            // éå†æ‰€æœ‰è´¨æŠ¼è®°å½•
            for (let i = 0; i < stakeInfo.length; i++) {
                const record = stakeInfo[i];
                const stakeTime = Number(record.stakeTime);
                const amount = parseFloat(ethers.formatUnits(record.stakeAmount, 18));
                
                // ã€ä¿®å¤ã€‘è®¡ç®—è´¨æŠ¼æ—¶é—´æ˜¯å¦åœ¨ä»Šå¤©
                if (stakeTime >= todayStart) {
                    todayStakeAmount += amount;
                }
                
                // ã€ä¿®å¤ã€‘å¦‚æœå·²èµå›ï¼Œä½†æ— æ³•è·å–èµå›æ—¶é—´ï¼Œæˆ‘ä»¬å‡è®¾èµå›æ—¶é—´åœ¨è´¨æŠ¼æ—¶é—´ä¹‹å
                // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šå¦‚æœå·²èµå›ä¸”è´¨æŠ¼æ—¶é—´åœ¨ä»Šå¤©ï¼Œåˆ™è®¡å…¥ä»Šæ—¥èµå›é‡
                if (record.isRedeem === 1 && stakeTime >= todayStart) {
                    todayRedeemAmount += amount;
                }
            }
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('todayStakeAmount').innerText = todayStakeAmount.toFixed(2);
            document.getElementById('todayRedeemAmount').innerText = todayRedeemAmount.toFixed(2);
            
        } catch (error) {
            console.error("è®¡ç®—æ¯æ—¥ç»Ÿè®¡å¤±è´¥:", error);
            document.getElementById('todayStakeAmount').innerText = "0.00";
            document.getElementById('todayRedeemAmount').innerText = "0.00";
        }
    }

    // ã€ä¿®å¤ç‚¹5ï¼šä¿®å¤è´¨æŠ¼è®°å½•å¡ç‰‡çš„çŠ¶æ€å’Œå€’è®¡æ—¶è¿›åº¦ã€‘
    async function renderStakeCards() {
        const container = document.getElementById('stakeCardsContainer');
        container.innerHTML = '<div class="text-center py-3"><div class="loading-spinner"></div> åŠ è½½ä¸­...</div>';

        try {
            const stakeInfo = await stakingContract.userStakeInfo(userAddress);
            
            if (!stakeInfo || stakeInfo.length === 0) {
                container.innerHTML = `
                    <div class="stake-empty-state">
                        <div class="stake-empty-icon">ğŸ“Š</div>
                        <div class="stake-empty-text">æš‚æ— è´¨æŠ¼è®°å½•</div>
                        <div class="stake-empty-subtext">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡è´¨æŠ¼å§ï¼</div>
                    </div>
                `;
                return;
            }

            let html = '';
            const now = Math.floor(Date.now() / 1000);

            Object.keys(countdownTimers).forEach(id => {
                clearInterval(countdownTimers[id]);
                delete countdownTimers[id];
            });

            // å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            for (let i = stakeInfo.length - 1; i >= 0; i--) {
                const record = stakeInfo[i];
                
                const amount = parseFloat(ethers.formatUnits(record.stakeAmount, 18));
                const stakeTime = Number(record.stakeTime);
                const stakeTimeStr = formatStakeTime(stakeTime);
                const isRedeemed = record.isRedeem === 1;
                const stakeDay = Number(record.stakeDay);
                const cycle = Number(record.cycle);
                
                const durationSeconds = STAKE_DURATIONS[stakeDay] || 86400;
                const durationLabel = STAKE_DURATION_LABELS[stakeDay] || "æœªçŸ¥";
                
                // ã€ä¿®å¤ç‚¹6ï¼šæ­£ç¡®è®¡ç®—è§£é”æ—¶é—´ - stakeDayæ˜¯å¤©æ•°ï¼Œcycleæ˜¯æœŸæ•°ã€‘
                const totalLockDays = stakeDay * cycle;
                const totalLockSeconds = totalLockDays * 86400;
                const unlockTime = stakeTime + totalLockSeconds;
                const timeRemaining = unlockTime - now;
                
                // ã€ä¿®å¤ç‚¹7ï¼šæ­£ç¡®åˆ¤æ–­çŠ¶æ€ã€‘
                let statusText = '';
                let statusClass = '';
                
                if (isRedeemed) {
                    statusText = 'å·²èµå›';
                    statusClass = 'status-completed';
                } else if (timeRemaining > 0) {
                    statusText = 'é”å®šä¸­';
                    statusClass = 'status-locked';
                } else {
                    statusText = 'å¯èµå›';
                    statusClass = 'status-unlocked';
                }
                
                // æ ¹æ®ç­›é€‰æ¡ä»¶å†³å®šæ˜¯å¦æ˜¾ç¤º
                let shouldDisplay = false;
                if (myStakeFilter === 'all') {
                    shouldDisplay = true;
                } else if (myStakeFilter === 'active') {
                    shouldDisplay = !isRedeemed && timeRemaining > 0; // æ˜¾ç¤ºæœªèµå›ä¸”æœªåˆ°æœŸçš„
                } else if (myStakeFilter === 'completed') {
                    shouldDisplay = isRedeemed; // æ˜¾ç¤ºå·²èµå›çš„
                }
                
                if (!shouldDisplay) {
                    continue; // è·³è¿‡ä¸æ˜¾ç¤º
                }

                const remainingTimeStr = timeRemaining > 0 ? formatTimeShort(timeRemaining) : 'å·²è§£é”';
                const progressPercent = calculateProgress(stakeTime, stakeDay, cycle);

                html += `
                    <div class="stake-card" id="stake-card-${i}">
                        <div class="stake-card-header">
                            <div class="stake-card-id">No.${i + 1}</div>
                            <div class="stake-card-status ${statusClass}">${statusText}</div>
                        </div>
                        
                        <div class="stake-card-info">
                            <div class="stake-amount">${amount.toFixed(0)} USDT</div>
                            <div class="stake-meta">
                                <div class="stake-duration">
                                    <span class="badge-duration">${stakeDay}å¤© Ã— ${cycle}æœŸ</span>
                                </div>
                                <div class="stake-time">${stakeTimeStr}</div>
                            </div>
                        </div>
                        
                        <div class="stake-progress">
                            <div class="stake-progress-info">
                                <div class="stake-remaining-time">å‰©ä½™: ${remainingTimeStr}</div>
                                <div class="stake-progress-percent">${progressPercent}%</div>
                            </div>
                            <div class="stake-progress-bar">
                                <div class="stake-progress-fill" id="progress-${i}" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                        
                        <div class="stake-card-actions">
                            ${(statusText === 'å¯èµå›') ? 
                                `<button class="btn btn-warning btn-sm" id="unstake-btn-${i}" onclick="handleUnstake(${i})">èµå›</button>` : 
                                `<button class="btn btn-secondary btn-sm" disabled>${isRedeemed ? 'å·²èµå›' : 'ç­‰å¾…è§£é”'}</button>`
                            }
                        </div>
                    </div>
                `;
                
                if (statusText === 'é”å®šä¸­') {
                    startProgressCountdown(i, timeRemaining, totalLockSeconds, stakeTime, stakeDay, cycle);
                }
            }

            if (html === '') {
                let emptyText = 'æš‚æ— è´¨æŠ¼è®°å½•';
                if (myStakeFilter === 'active') emptyText = 'æš‚æ— è´¨æŠ¼ä¸­çš„è®°å½•';
                else if (myStakeFilter === 'completed') emptyText = 'æš‚æ— å·²èµå›çš„è®°å½•';
                
                container.innerHTML = `
                    <div class="stake-empty-state">
                        <div class="stake-empty-icon">ğŸ“Š</div>
                        <div class="stake-empty-text">${emptyText}</div>
                        <div class="stake-empty-subtext">${myStakeFilter === 'active' ? 'å¼€å§‹è´¨æŠ¼ä»¥åˆ›å»ºæ–°çš„è´¨æŠ¼è®°å½•' : 'å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡è´¨æŠ¼å§ï¼'}</div>
                    </div>
                `;
            } else {
                container.innerHTML = html;
            }
        } catch (error) {
            console.error("å¡ç‰‡åŠ è½½å¤±è´¥:", error);
            container.innerHTML = `
                <div class="stake-empty-state">
                    <div class="stake-empty-icon">âŒ</div>
                    <div class="stake-empty-text">åŠ è½½å¤±è´¥</div>
                    <div class="stake-empty-subtext">è¯·åˆ·æ–°é¡µé¢é‡è¯•</div>
                </div>
            `;
        }
    }

    // ã€ä¿®å¤ç‚¹8ï¼šä¿®å¤è¿›åº¦æ¡å€’è®¡æ—¶é€»è¾‘ã€‘
    function startProgressCountdown(id, remainingSeconds, totalLockSeconds, stakeTime, stakeDay, cycle) {
        const progressElement = document.getElementById(`progress-${id}`);
        const timeElement = document.querySelector(`#stake-card-${id} .stake-remaining-time`);
        const percentElement = document.querySelector(`#stake-card-${id} .stake-progress-percent`);
        
        if (!progressElement || !timeElement || !percentElement) return;
        
        const updateProgress = () => {
            const now = Math.floor(Date.now() / 1000);
            const elapsedTime = now - stakeTime;
            const totalSeconds = totalLockSeconds;
            
            if (elapsedTime >= totalSeconds) {
                timeElement.textContent = `å‰©ä½™: å·²è§£é”`;
                progressElement.style.width = '100%';
                percentElement.textContent = '100%';
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                const button = document.querySelector(`#unstake-btn-${id}`);
                if (button) {
                    button.disabled = false;
                    button.textContent = "èµå›";
                }
                
                // æ›´æ–°çŠ¶æ€æ ‡ç­¾
                const statusElement = document.querySelector(`#stake-card-${id} .stake-card-status`);
                if (statusElement) {
                    statusElement.textContent = 'å¯èµå›';
                    statusElement.className = 'stake-card-status status-unlocked';
                }
                
                clearInterval(countdownTimers[id]);
                return;
            }
            
            const remaining = totalSeconds - elapsedTime;
            const progressPercent = Math.min(100, Math.floor((elapsedTime / totalSeconds) * 100));
            
            timeElement.textContent = `å‰©ä½™: ${formatTimeShort(remaining)}`;
            progressElement.style.width = `${progressPercent}%`;
            percentElement.textContent = `${progressPercent}%`;
        };
        
        // ç«‹å³æ›´æ–°ä¸€æ¬¡
        updateProgress();
        
        // æ¯ç§’æ›´æ–°ä¸€æ¬¡
        countdownTimers[id] = setInterval(updateProgress, 1000);
    }

    // 4. è´¨æŠ¼é€»è¾‘
    async function handleStake() {
        if (!userAddress) {
            alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            return;
        }
        
        const amountStr = document.getElementById('stakeAmount').value;
        if (!amountStr || parseFloat(amountStr) <= 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è´¨æŠ¼é‡‘é¢");
            return;
        }
        
        const amount = parseFloat(amountStr);
        if (amount < 0.1) {
            alert("è´¨æŠ¼é‡‘é¢ä¸èƒ½å°äº0.1 USDT");
            return;
        }
        
        if (amount > 1000000) {
            alert("è´¨æŠ¼é‡‘é¢ä¸èƒ½è¶…è¿‡1,000,000 USDT");
            return;
        }
        
        try {
            const amountWei = ethers.parseUnits(amountStr, 18);
            const stakeBtn = document.querySelector('.stake-action-btn');
            const originalText = stakeBtn.textContent;
            
            try {
                stakeBtn.disabled = true;
                stakeBtn.textContent = "å¤„ç†ä¸­...";
                
                // æ£€æŸ¥ç½‘ç»œ
                await checkNetwork();
                
                // æ£€æŸ¥ç”¨æˆ·ä½™é¢æ˜¯å¦è¶³å¤Ÿ
                stakeBtn.textContent = "æ£€æŸ¥ä½™é¢...";
                const myBal = await usdtContract.balanceOf(userAddress);
                if (myBal < amountWei) {
                    alert("USDTä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼");
                    throw new Error("ä½™é¢ä¸è¶³");
                }
                
                // æ£€æŸ¥å¹¶æˆæƒ USDT
                stakeBtn.textContent = "æ£€æŸ¥æˆæƒ...";
                const allowance = await usdtContract.allowance(userAddress, CONFIG.STAKING);
                
                if (allowance < amountWei) {
                    stakeBtn.textContent = "æ­£åœ¨æˆæƒ USDT...";
                    try {
                        const txApprove = await usdtContract.approve(CONFIG.STAKING, ethers.MaxUint256);
                        const receipt = await txApprove.wait();
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    } catch (approveError) {
                        console.error("æˆæƒå¤±è´¥:", approveError);
                        if (approveError.code === 4001) {
                            alert("ç”¨æˆ·æ‹’ç»æˆæƒ");
                        } else {
                            alert(`æˆæƒå¤±è´¥: ${approveError.reason || approveError.message || "æœªçŸ¥é”™è¯¯"}`);
                        }
                        throw approveError;
                    }
                }
                
                // è®¡ç®—minTokenAmountï¼ˆè®¾ç½®ä¸º0è¡¨ç¤ºæ¥å—ä»»æ„æ•°é‡çš„ä»£å¸ï¼‰
                const minTokenAmount = 0;
                
                // ç¡®è®¤å¯¹è¯æ¡†
                const confirmStake = confirm(
                    `ç¡®è®¤è´¨æŠ¼ ${amountStr} USDT\n` +
                    `è´¨æŠ¼å‘¨æœŸ: ${selectedDuration}å¤©\n` +
                    `\næ˜¯å¦ç»§ç»­ï¼Ÿ`
                );
                
                if (!confirmStake) {
                    console.log("ç”¨æˆ·å–æ¶ˆè´¨æŠ¼");
                    throw new Error("ç”¨æˆ·å–æ¶ˆ");
                }
                
                // å‘èµ·è´¨æŠ¼
                stakeBtn.textContent = "æ­£åœ¨è´¨æŠ¼...";
                
                try {
                    // è°ƒç”¨è´¨æŠ¼å‡½æ•°
                    const txStake = await stakingContract.stake(
                        amountWei, 
                        minTokenAmount,
                        selectedDuration
                    );
                    
                    console.log("è´¨æŠ¼äº¤æ˜“å·²å‘é€ï¼Œå“ˆå¸Œ:", txStake.hash);
                    
                    // æ˜¾ç¤ºäº¤æ˜“å·²å‘é€
                    stakeBtn.textContent = "ç­‰å¾…ç¡®è®¤...";
                    alert(`è´¨æŠ¼äº¤æ˜“å·²å‘é€ï¼Œè¯·ç­‰å¾…ç¡®è®¤\näº¤æ˜“å“ˆå¸Œ: ${txStake.hash.substring(0, 10)}...`);
                    
                    // ç­‰å¾…äº¤æ˜“ç¡®è®¤
                    const receipt = await txStake.wait();
                    console.log("è´¨æŠ¼ç¡®è®¤ï¼ŒåŒºå—:", receipt.blockNumber);
                    
           
